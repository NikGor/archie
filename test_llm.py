#!/usr/bin/env python
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã LLM —Å–µ—Ä–≤–∏—Å–∞
"""

import os
import sys
import django
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'archie.settings')
django.setup()

from archie.services.llm_service import LLMService
import tempfile

def test_llm_service():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç LLM —Å–µ—Ä–≤–∏—Å"""
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ LLM —Å–µ—Ä–≤–∏—Å–∞...")
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False) as f:
        f.write("""
        –î–û–ì–û–í–û–† –ö–£–ü–õ–ò-–ü–†–û–î–ê–ñ–ò
        
        –≥. –ú–æ—Å–∫–≤–∞                                    01.01.2024
        
        –û–û–û "–ü—Ä–æ–¥–∞–≤–µ—Ü", –∏–º–µ–Ω—É–µ–º–æ–µ –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º "–ü—Ä–æ–¥–∞–≤–µ—Ü", –≤ –ª–∏—Ü–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ò–≤–∞–Ω–æ–≤–∞ –ò.–ò., 
        –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ –£—Å—Ç–∞–≤–∞, —Å –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∏ –û–û–û "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å", –∏–º–µ–Ω—É–µ–º–æ–µ 
        –≤ –¥–∞–ª—å–Ω–µ–π—à–µ–º "–ü–æ–∫—É–ø–∞—Ç–µ–ª—å", –≤ –ª–∏—Ü–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞ –ü–µ—Ç—Ä–æ–≤–∞ –ü.–ü., –¥–µ–π—Å—Ç–≤—É—é—â–µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–∞–Ω–∏–∏ 
        –£—Å—Ç–∞–≤–∞, —Å –¥—Ä—É–≥–æ–π —Å—Ç–æ—Ä–æ–Ω—ã, –∑–∞–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä –æ –Ω–∏–∂–µ—Å–ª–µ–¥—É—é—â–µ–º:
        
        1. –ü–†–ï–î–ú–ï–¢ –î–û–ì–û–í–û–†–ê
        –ü—Ä–æ–¥–∞–≤–µ—Ü –æ–±—è–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—Ç—å –≤ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ü–æ–∫—É–ø–∞—Ç–µ–ª—è —Ç–æ–≤–∞—Ä, –∞ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è 
        –ø—Ä–∏–Ω—è—Ç—å —Ç–æ–≤–∞—Ä –∏ —É–ø–ª–∞—Ç–∏—Ç—å –∑–∞ –Ω–µ–≥–æ —Ü–µ–Ω—É –≤ —Ä–∞–∑–º–µ—Ä–µ 100 000 (—Å—Ç–æ —Ç—ã—Å—è—á) —Ä—É–±–ª–µ–π.
        
        2. –ö–ê–ß–ï–°–¢–í–û –¢–û–í–ê–†–ê
        –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ì–û–°–¢ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —É—Å–ª–æ–≤–∏—è–º.
        
        3. –°–†–û–ö–ò –ò–°–ü–û–õ–ù–ï–ù–ò–Ø
        –¢–æ–≤–∞—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 10 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞.
        
        –ü–æ–¥–ø–∏—Å–∏ —Å—Ç–æ—Ä–æ–Ω:
        –ü—Ä–æ–¥–∞–≤–µ—Ü: _________________     –ü–æ–∫—É–ø–∞—Ç–µ–ª—å: _________________
        """)
        test_file_path = f.name
    
    try:
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º LLM —Å–µ—Ä–≤–∏—Å
        llm_service = LLMService()
        
        print(f"üìÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª: {test_file_path}")
        result = llm_service.analyze_document(test_file_path)
        
        print("\n‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:")
        print(f"üìù –ù–∞–∑–≤–∞–Ω–∏–µ: {result.get('title', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}")
        print(f"üè∑Ô∏è  –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {result.get('category', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')}")
        print(f"üìã –û–ø–∏—Å–∞–Ω–∏–µ: {result.get('description', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ')}")
        
        return result
        
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}")
        return None
        
    finally:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if os.path.exists(test_file_path):
            os.unlink(test_file_path)

if __name__ == "__main__":
    test_llm_service() 